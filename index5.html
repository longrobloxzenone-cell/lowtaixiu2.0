<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rocket Crash - Royal Edition V149</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap');
        body { background-color: #05070a; color: white; font-family: 'Inter', sans-serif; overflow: hidden; touch-action: manipulation; -webkit-user-select: none; user-select: none; width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        #game-canvas { width: 100%; height: 100%; background: radial-gradient(circle at center bottom, #111827 0%, #05070a 100%); }
        .multiplier-text { text-shadow: 0 0 30px rgba(139, 92, 246, 0.6); z-index: 5; font-variant-numeric: tabular-nums; }
        .btn-touch { transition: transform 0.1s; }
        .btn-touch:active { transform: scale(0.95); }
        .crash-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(3px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-5px, 0, 0); } 40%, 60% { transform: translate3d(5px, 0, 0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #loading-overlay {
            position: fixed; inset: 0; background: #05070a; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-[#05070a]">

    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="font-orbitron text-purple-400 animate-pulse uppercase tracking-[0.2em] text-[10px]">ƒêang c·∫£m ·ª©ng thi√™n ƒë·ªãa...</p>
    </div>

    <div class="px-3 py-2 flex justify-between items-center bg-gray-900/90 backdrop-blur-md border-b border-gray-800 z-20 shrink-0 h-14">
        <div class="flex items-center gap-2">
            <button onclick="goBack()" class="w-8 h-8 bg-gray-800 rounded-lg flex items-center justify-center active:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-900/40">
                <span class="text-base">üöÄ</span>
            </div>
            <div class="hidden sm:flex flex-col">
                <h1 class="text-[10px] font-orbitron font-bold tracking-widest text-purple-400 uppercase">Rocket Crash</h1>
                <span id="player-name-display" class="text-[10px] text-gray-400 font-bold truncate max-w-[100px]">·∫®n danh ƒë·∫°o h·ªØu</span>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <div class="bg-gray-800 px-3 py-1 rounded-full border border-gray-700 flex items-center gap-1.5 shadow-inner">
                <span id="balance-display" class="font-orbitron text-sm font-bold tracking-wide text-yellow-500 whitespace-nowrap">0</span>
            </div>
            <button id="admin-btn" onclick="toggleAdminPanel()" style="display: none;" class="w-8 h-8 bg-gray-800/50 rounded-full flex items-center justify-center text-gray-400 active:text-white border border-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </div>
    </div>

    <div class="flex-grow flex flex-col relative overflow-hidden">
        <div id="history-container" class="flex gap-2 px-2 py-1 bg-black/40 overflow-x-auto no-scrollbar whitespace-nowrap min-h-[36px] items-center border-b border-gray-800/50 shrink-0"></div>

        <div id="game-container" class="relative flex-grow w-full overflow-hidden">
            <canvas id="game-canvas"></canvas>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <div id="multiplier-display" class="text-7xl sm:text-8xl font-orbitron font-bold multiplier-text transition-all duration-75">1.00x</div>
                <div id="status-message" class="mt-2 text-sm font-bold uppercase tracking-[0.2em] opacity-0 transition-opacity text-purple-300">ƒê·ª¢I V√ÅN M·ªöI...</div>
                <div id="admin-indicator" class="mt-1 text-[10px] font-bold text-red-500 bg-red-900/30 px-2 py-0.5 rounded hidden animate-pulse uppercase tracking-widest font-black">V·∫≠n m·ªánh ƒëang b·ªã chi ph·ªëi</div>
            </div>
        </div>

        <div class="bg-gray-900 border-t border-gray-800 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.5)] shrink-0">
            <div class="max-w-6xl mx-auto p-2 safe-bottom">
                <div class="grid grid-cols-2 gap-2">
                    
                    <div class="bg-gray-800/80 p-2 rounded-xl border border-gray-700/50 flex flex-col gap-1.5">
                        <div class="flex justify-between items-center">
                            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Linh M√¥n 1</span>
                            <span id="profit-1" class="text-[9px] font-bold text-green-400 hidden"></span>
                        </div>
                        <div class="grid grid-cols-1 gap-1">
                            <div class="flex items-center gap-1 bg-gray-900 rounded-lg border border-gray-700 h-7 px-1.5 overflow-hidden">
                                <span class="text-gray-500 text-[9px] font-bold" id="label-0">100k</span>
                                <input type="number" id="bet-input-0" value="100000" class="w-full bg-transparent text-white font-orbitron text-[10px] focus:outline-none" oninput="formatLabel(0)">
                                <button onclick="adjustBet(0, 0.5)" class="text-[8px] text-gray-400 hover:text-white px-0.5">1/2</button>
                                <button onclick="adjustBet(0, 2)" class="text-[8px] text-gray-400 hover:text-white px-0.5">2x</button>
                            </div>
                            <div class="flex items-center gap-1 bg-gray-900 rounded-lg border border-gray-700 h-7 px-1.5 overflow-hidden">
                                <span class="text-purple-500 text-[8px] font-bold">AUTO</span>
                                <input type="number" id="auto-input-0" placeholder="‚â• 1.5" step="0.1" min="1.5" class="w-full bg-transparent text-white font-orbitron text-[10px] focus:outline-none">
                                <button id="auto-btn-0" onclick="toggleAuto(0)" class="bg-green-600 text-[8px] px-1.5 py-0.5 rounded font-bold hover:bg-green-500 transition-colors uppercase whitespace-nowrap">B·∫≠t</button>
                            </div>
                        </div>
                        <button id="btn-0" onclick="handleAction(0)" class="w-full h-9 bg-purple-600 rounded-xl font-bold text-[11px] btn-touch shadow-lg text-white flex flex-col items-center justify-center leading-tight uppercase">C∆∞·ª£c</button>
                    </div>

                    <div class="bg-gray-800/80 p-2 rounded-xl border border-gray-700/50 flex flex-col gap-1.5">
                        <div class="flex justify-between items-center">
                            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter">Linh M√¥n 2</span>
                            <span id="profit-2" class="text-[9px] font-bold text-green-400 hidden"></span>
                        </div>
                        <div class="grid grid-cols-1 gap-1">
                            <div class="flex items-center gap-1 bg-gray-900 rounded-lg border border-gray-700 h-7 px-1.5 overflow-hidden">
                                <span class="text-gray-500 text-[9px] font-bold" id="label-1">100k</span>
                                <input type="number" id="bet-input-1" value="100000" class="w-full bg-transparent text-white font-orbitron text-[10px] focus:outline-none" oninput="formatLabel(1)">
                                <button onclick="adjustBet(1, 0.5)" class="text-[8px] text-gray-400 hover:text-white px-0.5">1/2</button>
                                <button onclick="adjustBet(1, 2)" class="text-[8px] text-gray-400 hover:text-white px-0.5">2x</button>
                            </div>
                            <div class="flex items-center gap-1 bg-gray-900 rounded-lg border border-gray-700 h-7 px-1.5 overflow-hidden">
                                <span class="text-purple-500 text-[8px] font-bold">AUTO</span>
                                <input type="number" id="auto-input-1" placeholder="‚â• 1.5" step="0.1" min="1.5" class="w-full bg-transparent text-white font-orbitron text-[10px] focus:outline-none">
                                <button id="auto-btn-1" onclick="toggleAuto(1)" class="bg-green-600 text-[8px] px-1.5 py-0.5 rounded font-bold hover:bg-green-500 transition-colors uppercase whitespace-nowrap">B·∫≠t</button>
                            </div>
                        </div>
                        <button id="btn-1" onclick="handleAction(1)" class="w-full h-9 bg-purple-600 rounded-xl font-bold text-[11px] btn-touch shadow-lg text-white flex flex-col items-center justify-center leading-tight uppercase">C∆∞·ª£c</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-gray-900 w-full max-w-sm rounded-3xl border border-purple-500/30 shadow-2xl animate-pop-in overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-purple-600/20 px-5 py-4 border-b border-gray-800 flex justify-between items-center shrink-0">
                <h2 class="text-sm font-bold text-purple-400 font-orbitron uppercase tracking-widest">H·ªôi Ngh·ªã Qu·∫£n Tr·ªã</h2>
                <button onclick="toggleAdminPanel()" class="text-gray-500 hover:text-white text-2xl px-2">‚úï</button>
            </div>
            
            <div class="p-5 space-y-6 overflow-y-auto no-scrollbar flex-grow">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest">ƒê·ªãnh ƒêo·∫°t ƒêi·ªÉm N·ªï</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-next-result" placeholder="X.XX" step="0.01" min="1.00" class="flex-grow bg-black border border-gray-700 rounded-xl h-11 px-4 text-white font-orbitron text-sm outline-none focus:border-purple-500">
                        <button onclick="setAdminResult()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold px-4 rounded-xl text-xs uppercase shadow-lg">Set</button>
                    </div>
                </div>
                
                <button onclick="forceCrashNow()" class="w-full bg-red-600/20 hover:bg-red-600/40 border border-red-500/50 h-11 rounded-xl font-bold text-red-500 text-[10px] uppercase tracking-widest transition-all">K√≠ch N·ªï Ngay</button>
                
                <div id="sad-powers" class="hidden space-y-4 pt-5 border-t border-gray-800">
                    <p class="text-[9px] font-black text-yellow-500 uppercase tracking-[0.2em]">Quy·ªÅn SAD T·ªëi Cao</p>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">H·ªá s·ªë linh kh√≠</label>
                        <div class="flex gap-2">
                            <input type="number" id="admin-ratio-input" placeholder="1.0" step="0.1" min="0.1" class="flex-grow bg-black border border-gray-700 rounded-xl h-10 px-4 text-white font-orbitron text-xs outline-none focus:border-yellow-500">
                            <button onclick="setGameRatio()" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold px-4 rounded-xl text-[10px] uppercase">L∆∞u</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-blue-400 uppercase">Ph√°t l·ªánh Server</label>
                        <div class="flex flex-col gap-2">
                            <textarea id="admin-notice-input" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..." class="w-full bg-black border border-gray-700 rounded-xl p-3 text-white text-xs outline-none focus:border-blue-500 h-20 no-scrollbar"></textarea>
                            <button onclick="sendGlobalNotice()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold h-10 rounded-xl text-[10px] uppercase shadow-lg shadow-blue-900/20">Ph√°t l·ªánh ngay</button>
                        </div>
                    </div>
                    <button id="toggle-high-rate" onclick="toggleHighRate()" class="w-full bg-gray-800 border border-gray-700 h-10 rounded-xl font-bold text-gray-300 text-[10px] uppercase transition-all">
                        Ch·∫ø ƒë·ªô t·ªâ l·ªá cao: <span id="high-rate-status">T·∫ÆT</span>
                    </button>
                    <button onclick="clearAllHistory()" class="w-full bg-gray-700 h-9 rounded-xl font-bold text-white text-[10px] uppercase">X√≥a L·ªãch S·ª≠ Game</button>
                </div>
            </div>
            <div class="h-4 shrink-0"></div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-16 left-1/2 -translate-x-1/2 z-[60] flex flex-col items-center gap-2 pointer-events-none w-full px-4 text-center"></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCbESIH8uq5Q6R45ehisGp-Lsh9xz_ejDk", authDomain: "tx888-85658.firebaseapp.com", databaseURL: "https://tx888-85658-default-rtdb.firebaseio.com", projectId: "tx888-85658", storageBucket: "tx888-85658.firebasestorage.app", messagingSenderId: "246211516842", appId: "1:246211516842:web:24a3598d54b037676c73d3" };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database(), auth = firebase.auth();

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const multiplierDisplay = document.getElementById('multiplier-display');
        const statusMessage = document.getElementById('status-message');
        const balanceDisplay = document.getElementById('balance-display');
        const playerNameDisplay = document.getElementById('player-name-display');
        const historyContainer = document.getElementById('history-container');
        const adminIndicator = document.getElementById('admin-indicator');
        const loadingOverlay = document.getElementById('loading-overlay');

        let state = {
            user: null, balance: 0, multiplier: 1.00, targetCrash: 0, isFlying: false, isWaiting: false, crashed: false, startTime: 0, stars: [], particles: [], rocketY: 0,
            bets: [ 
                { amount: 0, active: false, pending: false, cashedOut: false, autoValue: 0, autoEnabled: false }, 
                { amount: 0, active: false, pending: false, cashedOut: false, autoValue: 0, autoEnabled: false } 
            ],
            adminOverride: null, highRateMode: false, gameRatio: 1.0, lastNoticeTimestamp: 0, isLoaded: false,
            lowStreak: 0 
        };

        function hideLoading() {
            if (state.isLoaded) return;
            state.isLoaded = true;
            if (loadingOverlay) {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
            }
        }

        setTimeout(() => { if (!state.isLoaded) hideLoading(); }, 6000);

        function formatMoney(n) {
            let num = Number(n);
            if (num >= 500000000000000) return "‚àû";
            if (num >= 1000000000000) return (num / 1000000000000).toFixed(1) + "T";
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + "B";
            if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
            if (num >= 1000) return (num / 1000).toFixed(1) + "k";
            return num.toLocaleString();
        }

        function formatLabel(i) {
            const val = document.getElementById(`bet-input-${i}`).value;
            if (document.getElementById(`label-${i}`)) document.getElementById(`label-${i}`).innerText = formatMoney(val || 0);
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                listenToServerNotice();
                db.ref('users/' + user.uid).on('value', s => {
                    const data = s.val();
                    if (!data) {
                        db.ref('users/' + user.uid).set({ name: "T√¢n th·ªß ƒë·∫°o h·ªØu", money: 1000000, isAdmin: false, isSuperAdmin: false });
                        return;
                    }
                    state.user = { uid: user.uid, ...data };
                    state.balance = data.money;
                    updateUI();
                    playerNameDisplay.innerText = data.name || "·∫®n danh ƒë·∫°o h·ªØu";
                    const ab = document.getElementById('admin-btn');
                    const sadP = document.getElementById('sad-powers');
                    if (data.isSuperAdmin || data.isAdmin) ab.style.display = 'flex';
                    if (data.isSuperAdmin) sadP.classList.remove('hidden');
                    else sadP.classList.add('hidden');
                    
                    if (!state.isLoaded) {
                        hideLoading();
                        seedInitialHistory();
                    }
                    if (!state.isWaiting && !state.isFlying && !state.crashed) {
                        startGlobalTimer();
                    }
                });
            } else { window.location.href = "index.html"; }
        });

        function seedInitialHistory() {
            if (historyContainer.children.length > 0) return;
            for(let i=0; i<3; i++) { addHistory(1.1 + (Math.random() * 0.8)); }
        }

        function listenToServerNotice() {
            db.ref('server/notice').on('value', snap => {
                const notice = snap.val();
                if (notice && notice.timestamp > state.lastNoticeTimestamp) {
                    if (state.lastNoticeTimestamp !== 0) showToast(`üì¢ L·ªÜNH SERVER: ${notice.text}`, "info");
                    state.lastNoticeTimestamp = notice.timestamp;
                }
            });
        }

        function updateDB() { if (state.user) db.ref('users/' + state.user.uid).update({ money: state.balance }); }
        function goBack() { if(confirm("üî• R√∫t lui kh·ªèi linh ƒë·ªãa?")) window.location.href = "index.html"; }
        function resize() { 
            canvas.width = canvas.parentElement.clientWidth; 
            canvas.height = canvas.parentElement.clientHeight; 
            initStars(); 
            state.rocketY = canvas.height * 0.7; 
        }
        window.addEventListener('resize', resize);
        function initStars() { state.stars = []; for(let i=0; i<60; i++) state.stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 1.5 + 0.5, speed: Math.random() * 2 + 0.5 }); }

        function calculateCrashPoint() {
            if (state.adminOverride !== null) {
                const val = state.adminOverride; state.adminOverride = null;
                adminIndicator.classList.remove('hidden'); setTimeout(() => adminIndicator.classList.add('hidden'), 3000);
                state.lowStreak = 0;
                return val;
            }
            let result = 1.00;
            let bigWinChance = 0.05 + (state.lowStreak * 0.15); 
            if (Math.random() < bigWinChance) {
                result = 4.00 + (Math.random() * 26.00); 
                state.lowStreak = 0;
            } else {
                if (state.highRateMode) {
                    let r = Math.random() * 1000;
                    if (r < 0.5) result = (Math.random() * 5000 + 1000); 
                    else if (r < 2.5) result = (Math.random() * 450 + 50);    
                    else if (r < 22.5) result = (Math.random() * 40 + 10);   
                    else result = (Math.random() * 9 + 1.1);                 
                } else {
                    const chance = Math.random() * 100;
                    if (chance < 15) result = 1.00;
                    else if (chance < 70) result = 1.01 + (Math.random() * 0.69);
                    else if (chance < 95) result = 1.70 + (Math.random() * 1.30);
                    else result = 3.00 + (Math.random() * 5.00);
                }
                if (result < 2.00) state.lowStreak++;
                else state.lowStreak = Math.max(0, state.lowStreak - 1);
            }
            result = result * (state.gameRatio || 1.0);
            return Math.max(1.00, Math.floor(result * 100) / 100);
        }

        function startGlobalTimer() {
            if (state.isWaiting || state.isFlying) return;
            state.isWaiting = true; 
            statusMessage.style.opacity = "1";
            let count = 10;
            statusMessage.innerText = `KH·ªûI ƒê·ªòNG TRONG ${count}`;
            let gameTimer = setInterval(() => { 
                count--; 
                if (count > 0) statusMessage.innerText = `KH·ªûI ƒê·ªòNG TRONG ${count}`; 
                else { clearInterval(gameTimer); launchRocket(); } 
            }, 1000);
        }

        function launchRocket() {
            state.isWaiting = false; state.isFlying = true; state.startTime = Date.now();
            state.targetCrash = calculateCrashPoint(); 
            statusMessage.style.opacity = "0";
            state.bets.forEach((bet, i) => {
                if (bet.pending) { 
                    bet.active = true; bet.pending = false; 
                    const autoInp = parseFloat(document.getElementById(`auto-input-${i}`).value);
                    bet.autoValue = (bet.autoEnabled && !isNaN(autoInp) && autoInp >= 1.5) ? autoInp : 0;
                    updateButtonState(i, 'active'); 
                    if (document.getElementById(`profit-${i+1}`)) document.getElementById(`profit-${i+1}`).classList.remove('hidden'); 
                } else { updateButtonState(i, 'disabled'); }
            });
        }

        function crash() {
            state.isFlying = false; state.crashed = true;
            document.getElementById('game-container').classList.add('crash-shake');
            multiplierDisplay.classList.add('text-red-500'); 
            statusMessage.innerText = "S·ª§P ƒê·ªî!"; statusMessage.style.opacity = "1";
            addHistory(state.multiplier); createExplosion(canvas.width / 2, state.rocketY);
            state.bets.forEach((bet, i) => { 
                if (bet.active && !bet.cashedOut) updateButtonState(i, 'crashed'); 
                if (document.getElementById(`profit-${i+1}`)) document.getElementById(`profit-${i+1}`).classList.add('hidden'); 
            });
            setTimeout(resetGame, 3000);
        }

        function resetGame() {
            state.isFlying = false; state.crashed = false; state.multiplier = 1.00;
            multiplierDisplay.innerText = "1.00x"; multiplierDisplay.classList.remove('text-red-500'); statusMessage.style.opacity = "0";
            state.bets.forEach((bet, i) => { 
                bet.active = false; bet.cashedOut = false; 
                if (!bet.pending) { updateButtonState(i, 'default'); } 
                else { updateButtonState(i, 'pending'); }
            });
            startGlobalTimer();
        }

        function update() {
            const speedScale = state.isFlying ? Math.min(state.multiplier, 15) : 1;
            if (state.isFlying) {
                const elapsed = (Date.now() - state.startTime) / 1000;
                state.multiplier = Math.pow(Math.E, 0.07 * elapsed);
                state.bets.forEach((bet, i) => {
                    if (bet.active && !bet.cashedOut && bet.autoValue > 0 && state.multiplier >= bet.autoValue) { handleAction(i); }
                });
                if (state.multiplier >= state.targetCrash) { state.multiplier = state.targetCrash; crash(); }
                multiplierDisplay.innerText = state.multiplier.toFixed(2) + "x";
                state.bets.forEach((bet, i) => { 
                    if (bet.active && !bet.cashedOut) { 
                        const cur = Math.floor(bet.amount * state.multiplier); 
                        if (document.getElementById(`profit-${i+1}`)) document.getElementById(`profit-${i+1}`).innerText = `L√£i: +$${formatMoney(cur)}`; 
                    } 
                });
                for(let i=0; i<2; i++) state.particles.push({ x: canvas.width/2 + (Math.random()-0.5)*10, y: state.rocketY + 25, vx: (Math.random()-0.5)*2, vy: (Math.random()*5 + 5) * (speedScale * 0.4), life: 1, size: Math.random()*5 + 3, color: `hsla(${10 + Math.random()*40}, 100%, 50%, 0.8)` });
            }
            state.stars.forEach(s => { s.y += s.speed * (state.isFlying ? speedScale * 0.5 : 0.2); if (s.y > canvas.height) { s.y = -10; s.x = Math.random() * canvas.width; } });
            for (let i = state.particles.length - 1; i >= 0; i--) { let p = state.particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.04; if (p.life <= 0) state.particles.splice(i, 1); }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            state.stars.forEach(s => { ctx.globalAlpha = (0.3 + (s.speed/4)) * (state.isFlying ? 0.5 : 1); ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill(); });
            state.particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill(); });
            ctx.globalAlpha = 1;
            if (!state.crashed) { 
                ctx.save(); ctx.translate(canvas.width / 2, state.rocketY); 
                if (state.isFlying) { const s = Math.min(2, state.multiplier / 10); ctx.translate((Math.random()-0.5)*s, (Math.random()-0.5)*s); } 
                ctx.font = "60px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.rotate(-Math.PI / 4); ctx.shadowBlur = 20; ctx.shadowColor = "rgba(168, 85, 247, 0.6)"; ctx.fillText("üöÄ", 0, 0); ctx.restore(); 
            }
        }

        function createExplosion(x, y) { for(let i=0; i<40; i++) state.particles.push({ x: x, y: y, vx: (Math.random()-0.5)*30, vy: (Math.random()-0.5)*30, life: 1.5, size: Math.random()*8 + 2, color: i % 2 === 0 ? "#ef4444" : "#f59e0b" }); }
        
        function updateUI() { 
            balanceDisplay.innerText = formatMoney(state.balance); 
            state.bets.forEach((bet, i) => { if (!bet.active && !bet.pending && !bet.cashedOut) { updateButtonState(i, 'default'); } });
        }

        function addHistory(val) { 
            const item = document.createElement('div'); 
            item.className = `px-3 py-1 rounded-lg text-[10px] font-orbitron font-bold border ${val < 2 ? 'text-gray-500 border-gray-800' : 'text-purple-400 border-purple-500/30'} flex-shrink-0`; 
            item.innerText = val.toFixed(2) + 'x'; 
            historyContainer.prepend(item); 
            if (historyContainer.children.length > 20) historyContainer.lastChild.remove(); 
        }

        function showToast(text, type) { 
            const container = document.getElementById('toast-container'); 
            const toast = document.createElement('div'); 
            const colorClass = type === 'success' ? 'bg-green-600' : (type === 'info' ? 'bg-blue-600' : 'bg-red-600');
            toast.className = `${colorClass} text-white px-5 py-2.5 rounded-2xl shadow-xl font-bold text-[11px] mb-2 animate-bounce border border-white/20 backdrop-blur-sm pointer-events-none`; 
            toast.innerHTML = text; container.appendChild(toast); 
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, 5000); 
        }

        function adjustBet(i, factor) {
            const input = document.getElementById(`bet-input-${i}`);
            if (state.bets[i].pending || (state.bets[i].active && !state.crashed)) return;
            let newVal = Math.floor((parseFloat(input.value) || 0) * factor);
            if (factor > 1 && newVal > state.balance) newVal = state.balance;
            if(newVal < 100000 && state.balance >= 100000) newVal = 100000;
            else if (newVal < 100000 && state.balance < 100000) newVal = state.balance;
            input.value = newVal; formatLabel(i);
        }

        function toggleAuto(i) {
            const bet = state.bets[i];
            const btn = document.getElementById(`auto-btn-${i}`);
            const input = document.getElementById(`auto-input-${i}`);
            if (!bet.autoEnabled) {
                const val = parseFloat(input.value);
                if (isNaN(val) || val < 1.5) { showToast("T·ª± ƒë·ªông r√∫t ph·∫£i ‚â• 1.5x", "error"); return; }
                bet.autoEnabled = true; btn.innerText = "T·∫Øt";
                btn.className = "bg-red-600 text-[8px] px-1.5 py-0.5 rounded font-bold hover:bg-red-500 transition-colors uppercase whitespace-nowrap";
                showToast("ƒê√£ k√≠ch ho·∫°t t·ª± ƒë·ªông r√∫t", "success");
            } else {
                bet.autoEnabled = false; btn.innerText = "B·∫≠t";
                btn.className = "bg-green-600 text-[8px] px-1.5 py-0.5 rounded font-bold hover:bg-green-500 transition-colors uppercase whitespace-nowrap";
                showToast("ƒê√£ t·∫Øt t·ª± ƒë·ªông r√∫t", "info");
            }
        }

        function handleAction(index) {
            const bet = state.bets[index];
            if (state.isFlying && bet.active && !bet.cashedOut && !state.crashed) {
                const win = Math.floor(bet.amount * state.multiplier);
                state.balance += win; bet.cashedOut = true; updateDB(); updateUI();
                updateButtonState(index, 'cashed'); 
                showToast(`+$${formatMoney(win)}`, "success");
                if (document.getElementById(`profit-${index+1}`)) document.getElementById(`profit-${index+1}`).classList.add('hidden'); 
                return;
            }
            if (bet.pending) {
                state.balance += bet.amount; bet.pending = false; bet.amount = 0;
                updateDB(); updateUI(); updateButtonState(index, 'default'); 
                showToast("ƒê√£ h·ªßy c∆∞·ª£c v√°n sau", "info"); return;
            }
            if (!bet.active && !bet.pending) {
                const amount = parseFloat(document.getElementById(`bet-input-${index}`).value);
                if (isNaN(amount) || amount < 100000) return showToast("Min c∆∞·ª£c 100k!", "error");
                if (amount > state.balance) return showToast("Linh th·∫°ch kh√¥ng ƒë·ªß!", "error");
                state.balance -= amount; bet.amount = amount; bet.pending = true;
                updateDB(); updateUI(); updateButtonState(index, 'pending');
                if (state.isFlying) { showToast("ƒê√£ ƒë·∫∑t c∆∞·ª£c cho v√°n t·ªõi!", "info"); }
            }
        }

        function updateButtonState(i, status) {
            const btn = document.getElementById(`btn-${i}`);
            if (!btn) return;
            if (status === 'default') { 
                btn.className = "w-full h-9 bg-purple-600 rounded-xl font-bold text-[11px] btn-touch text-white flex flex-col items-center justify-center shadow-lg uppercase"; 
                btn.innerHTML = (state.isFlying || state.crashed) ? "V√ÅN SAU" : "C∆Ø·ª¢C"; 
                btn.disabled = false; btn.classList.remove('opacity-50');
            }
            else if (status === 'pending') { 
                btn.className = "w-full h-9 bg-red-600 rounded-xl font-bold text-[11px] text-white flex flex-col items-center justify-center shadow-inner uppercase btn-touch"; 
                btn.innerHTML = "H·ª¶Y"; btn.disabled = false;
            }
            else if (status === 'active') { 
                btn.className = "w-full h-9 bg-orange-500 rounded-xl font-bold text-[11px] text-white flex flex-col items-center justify-center btn-touch shadow-lg uppercase"; 
                btn.innerHTML = "R√öT"; btn.disabled = false; btn.classList.remove('opacity-50');
            }
            else if (status === 'cashed' || status === 'crashed') { 
                btn.className = "w-full h-9 bg-gray-800 rounded-xl font-bold text-[11px] text-gray-500 border border-gray-700 flex flex-col items-center justify-center uppercase"; 
                btn.innerHTML = status === 'cashed' ? "XONG" : "THUA"; btn.disabled = true; 
            }
            else if (status === 'disabled') { btn.disabled = true; btn.classList.add('opacity-50'); }
        }

        function toggleAdminPanel() { document.getElementById('admin-modal').classList.toggle('hidden'); }
        function setAdminResult() { const val = parseFloat(document.getElementById('admin-next-result').value); if (val >= 1) { state.adminOverride = val; showToast(`X√°c l·∫≠p: ${val}x`, "success"); toggleAdminPanel(); } }
        function forceCrashNow() { if (state.isFlying) { state.targetCrash = state.multiplier; toggleAdminPanel(); } }
        function clearAllHistory() { historyContainer.innerHTML = ""; showToast("X√≥a l·ªãch s·ª≠ th√†nh c√¥ng!", "success"); }
        function sendGlobalNotice() { const input = document.getElementById('admin-notice-input'); const msg = input.value.trim(); if(msg) db.ref('server/notice').set({ text: msg, timestamp: Date.now() }).then(() => { showToast("ƒê√£ ph√°t l·ªánh!", "success"); input.value = ""; }); }
        function setGameRatio() { const val = parseFloat(document.getElementById('admin-ratio-input').value); if (!isNaN(val) && val > 0) { state.gameRatio = val; showToast(`H·ªá s·ªë: ${val}x`, "success"); } }
        function toggleHighRate() { state.highRateMode = !state.highRateMode; document.getElementById('high-rate-status').innerText = state.highRateMode ? "B·∫¨T" : "T·∫ÆT"; showToast(state.highRateMode ? "B·∫≠t t·ªâ l·ªá cao!" : "T·∫Øt t·ªâ l·ªá cao.", state.highRateMode ? "success" : "error"); }
        window.onload = () => { resize(); const loop = () => { update(); draw(); requestAnimationFrame(loop); }; loop(); };
    </script>
</body>
</html>
