<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rocket Crash - Royal Edition</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; user-select: none; }
        body { background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; height: 100svh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .header { height: 55px; padding: 0 15px; background: #0b0e11; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1e2329; flex-shrink: 0; z-index: 100; }
        #userMoney { color: #00ff88; font-weight: 900; font-size: 16px; }

        /* HISTORY BAR */
        #historyBar { height: 35px; background: #14181d; display: flex; align-items: center; gap: 8px; padding: 0 10px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #1e2329; scrollbar-width: none; }
        .h-item { font-size: 11px; font-weight: 800; padding: 3px 8px; border-radius: 12px; background: #2b3139; }
        .h-red { color: #ff4d4d; border: 1px solid #ff4d4d; }
        .h-green { color: #00ff88; border: 1px solid #00ff88; }

        /* GAME AREA */
        #gameArea { position: relative; flex: 1; width: 100%; background: radial-gradient(circle at 50% 50%, #0a192f 0%, #020b16 100%); overflow: hidden; }
        .sky-bg { position: absolute; width: 300%; height: 300%; top: -100%; left: -100%; background-image: radial-gradient(1.5px 1.5px at 50px 80px, #fff, rgba(0,0,0,0)), radial-gradient(2px 2px at 150px 250px, #00f2fe, rgba(0,0,0,0)); background-size: 300px 300px; opacity: 0; transition: opacity 1s; z-index: 1; }
        .sky-active { opacity: 0.5; animation: moveSky 2s linear infinite; }
        @keyframes moveSky { from { transform: translate(0, 0); } to { transform: translate(-150px, 150px); } }

        /* ROCKET & DISPLAY */
        #rocket { position: absolute; font-size: 45px; bottom: 30px; left: 30px; z-index: 10; transition: transform 0.1s linear; }
        #displayCenter { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; z-index: 20; }
        #multiNum { font-size: 70px; font-weight: 900; color: #fff; text-shadow: 0 0 30px rgba(0,255,136,0.3); }
        #countdown { color: #ffd700; font-size: 14px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; margin-top: 10px; }

        /* CONTROLS */
        .controls-wrapper { height: 160px; background: #0b0e11; padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; border-top: 1px solid #1e2329; flex-shrink: 0; }
        .bet-card { background: #1e2329; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #2b3139; }
        .input-box { display: flex; justify-content: space-between; align-items: center; background: #000; border-radius: 8px; padding: 8px 12px; }
        .input-box span { color: #ffd700; font-size: 22px; font-weight: bold; cursor: pointer; padding: 0 5px; }
        .input-box b { font-size: 15px; color: #fff; }

        .btn-main { width: 100%; height: 55px; border-radius: 10px; border: none; font-weight: 900; font-size: 15px; text-transform: uppercase; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-bet { background: #005a34; color: #00ff88; border: 1px solid #00ff88; }
        .btn-cancel { background: #b71c1c; color: #fff; }
        .btn-cashout { background: #00c853; color: #fff; box-shadow: 0 0 15px rgba(0,200,83,0.5); }
        .btn-done { background: #2b3139; color: #848e9c; cursor: default; }
        .btn-main span { font-size: 9px; opacity: 0.8; font-weight: normal; margin-top: 4px; }

        /* ADMIN PANEL OVERLAY */
        #adminOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; padding: 20px; }
        .admin-box { background: #1e2329; border: 2px solid #ff0000; border-radius: 20px; padding: 20px; max-width: 400px; margin: 40px auto; }
        .admin-btn { width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="header">
    <button onclick="window.location.href='index.html'" style="background:none; border:none; color:#848e9c; font-size:24px;">‚úï</button>
    <div id="userMoney">ƒêANG T·∫¢I...</div>
    <div id="adminIcon" onclick="toggleAdmin()" style="cursor:pointer; display:none; font-size:20px;">‚öôÔ∏è</div>
</div>

<div id="historyBar"></div>

<div id="gameArea">
    <div id="skyBg" class="sky-bg"></div>
    <div id="displayCenter">
        <h1 id="multiNum">1.00x</h1>
        <div id="countdown">ƒêANG K·∫æT N·ªêI...</div>
    </div>
    <div id="rocket">üöÄ</div>
</div>

<div class="controls-wrapper">
    <div class="bet-card">
        <div class="input-box"><span onclick="adjust(1,-100000)">‚àí</span><b id="betTxt1">100K</b><span onclick="adjust(1,100000)">+</span></div>
        <button id="btn1" onclick="act(1)" class="btn-main btn-bet">C∆Ø·ª¢C<span>V√≤ng t·ªõi</span></button>
    </div>
    <div class="bet-card">
        <div class="input-box"><span onclick="adjust(2,-100000)">‚àí</span><b id="betTxt2">100K</b><span onclick="adjust(2,100000)">+</span></div>
        <button id="btn2" onclick="act(2)" class="btn-main btn-bet">C∆Ø·ª¢C<span>V√≤ng t·ªõi</span></button>
    </div>
</div>

<div id="adminOverlay" onclick="toggleAdmin()">
    <div class="admin-box" onclick="event.stopPropagation()">
        <h2 style="color:#ff0000; text-align:center; margin-bottom:20px;">MASTER CONTROL</h2>
        <div id="sadOnly" style="display:none;">
            <button class="admin-btn" style="background:#b71c1c; color:#fff;" onclick="srvLock(true)">KH√ìA TO√ÄN SERVER</button>
            <button class="admin-btn" style="background:#2e7d32; color:#fff;" onclick="srvLock(false)">M·ªû TO√ÄN SERVER</button>
            <hr style="margin:15px 0; opacity:0.2;">
        </div>
        <button class="admin-btn" style="background:#f57c00; color:#fff;" onclick="toggleGameLock()">KH√ìA/M·ªû GAME N√ÄY</button>
        <button class="admin-btn" style="background:#333; color:#fff; margin-top:30px;" onclick="toggleAdmin()">ƒê√ìNG B·∫¢NG</button>
    </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyCbESIH8uq5Q6R45ehisGp-Lsh9xz_ejDk", authDomain: "tx888-85658.firebaseapp.com", databaseURL: "https://tx888-85658-default-rtdb.firebaseio.com", projectId: "tx888-85658", storageBucket: "tx888-85658.firebasestorage.app", messagingSenderId: "246211516842", appId: "1:246211516842:web:24a3598d54b037676c73d3" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database(), auth = firebase.auth();

let userData = null, isPlaying = false, isWaiting = true, currentX = 1.00, crashX = 0;
let bets = { 1: { amt: 100000, active: false, cashed: false }, 2: { amt: 100000, active: false, cashed: false } };

function nFormatter(num) {
    if (num >= 1000000000000) return (num / 1000000000000).toFixed(1) + 'T';
    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(0) + 'k';
    return num;
}

auth.onAuthStateChanged(user => {
    if (user) {
        db.ref('users/' + user.uid).on('value', s => {
            userData = s.val(); userData.uid = user.uid;
            document.getElementById('userMoney').innerText = nFormatter(userData.money) + " $";
            // QUY·ªÄN ADMIN: HI·ªÇN TH·ªä ICON C√ÄI ƒê·∫∂T
            if(userData.isSuperAdmin || userData.isAdmin) {
                document.getElementById('adminIcon').style.display = "block";
                if(userData.isSuperAdmin) document.getElementById('sadOnly').style.display = "block";
            }
        });
        loadHistory();
    } else { window.location.href = "index.html"; }
});

// L·ªäCH S·ª¨ BAY T·ª™ FIREBASE
function loadHistory() {
    db.ref('game_rocket_history').limitToLast(15).on('value', s => {
        let h = ""; 
        s.forEach(child => {
            let val = child.val().x;
            let cls = val >= 2 ? "h-green" : "h-red";
            h = `<div class="h-item ${cls}">${val.toFixed(2)}x</div>` + h;
        });
        document.getElementById('historyBar').innerHTML = h;
    });
}

function adjust(n, v) {
    if(isPlaying || (isWaiting && bets[n].active)) return;
    bets[n].amt = Math.max(100000, bets[n].amt + v);
    document.getElementById('betTxt'+n).innerText = nFormatter(bets[n].amt);
}

function startWaiting() {
    isWaiting = true; isPlaying = false;
    let t = 8;
    document.getElementById('skyBg').classList.remove('sky-active');
    document.getElementById('multiNum').innerText = "V√ÄO C∆Ø·ª¢C";
    document.getElementById('multiNum').style.color = "#fff";
    document.getElementById('rocket').innerText = "üöÄ";
    document.getElementById('rocket').style.bottom = "30px";
    document.getElementById('rocket').style.left = "30px";
    document.getElementById('rocket').style.transform = "rotate(0deg)";

    let timer = setInterval(() => {
        document.getElementById('countdown').innerText = "B·∫ÆT ƒê·∫¶U TRONG " + t + "S";
        if(t <= 0) { clearInterval(timer); document.getElementById('countdown').innerText = "ƒêANG BAY..."; startFlying(); }
        t--;
    }, 1000);
}

function startFlying() {
    isWaiting = false; isPlaying = true;
    currentX = 1.00;
    // Thu·∫≠t to√°n Crash ng·∫´u nhi√™n
    crashX = (100 / (100 - (Math.random() * 97))).toFixed(2);
    if(crashX < 1.01) crashX = 1.01;
    
    [1,2].forEach(n => {
        let b = document.getElementById('btn'+n);
        if(bets[n].active) {
            b.className = "btn-main btn-cashout";
            b.innerHTML = "R√öT TI·ªÄN<span>" + nFormatter(bets[n].amt) + "</span>";
        } else { b.className = "btn-main btn-done"; b.innerHTML = "ƒêANG BAY<span>...</span>"; }
    });

    let loop = setInterval(() => {
        currentX += 0.01 + (currentX / 150);
        document.getElementById('multiNum').innerText = currentX.toFixed(2) + "x";
        
        [1,2].forEach(n => { 
            if(bets[n].active && !bets[n].cashed) {
                document.getElementById('btn'+n).innerHTML = "R√öT TI·ªÄN<span>+" + nFormatter(Math.floor(bets[n].amt * currentX)) + "</span>";
            }
        });
        
        let r = document.getElementById('rocket');
        let pos = (currentX - 1) * 70;
        if (pos < 180) {
            r.style.bottom = (30 + pos * 0.7) + "px";
            r.style.left = (30 + pos * 1.1) + "px";
            r.style.transform = "rotate(-45deg)";
        } else {
            document.getElementById('skyBg').classList.add('sky-active');
            r.style.transform = `rotate(-45deg) translate(${Math.random()*2}px, ${Math.random()*2}px)`;
        }

        if(currentX >= crashX) { clearInterval(loop); crash(); }
    }, 100);
}

function act(n) {
    if(!userData) return;
    let b = document.getElementById('btn'+n);
    if(isWaiting && !bets[n].active) {
        if(userData.money < bets[n].amt) return;
        bets[n].active = true; bets[n].cashed = false;
        db.ref('users/'+userData.uid).update({ money: userData.money - bets[n].amt });
        b.className = "btn-main btn-cancel";
        b.innerHTML = "H·ª¶Y<span>" + nFormatter(bets[n].amt) + "</span>";
    } else if(isWaiting && bets[n].active) {
        bets[n].active = false;
        db.ref('users/'+userData.uid).update({ money: userData.money + bets[n].amt });
        b.className = "btn-main btn-bet";
        b.innerHTML = "C∆Ø·ª¢C<span>V√≤ng t·ªõi</span>";
    } else if(isPlaying && bets[n].active && !bets[n].cashed) {
        let win = Math.floor(bets[n].amt * currentX);
        db.ref('users/'+userData.uid).update({ money: userData.money + win });
        bets[n].cashed = true;
        b.className = "btn-main btn-done";
        b.innerHTML = "ƒê√É R√öT<span>+" + nFormatter(win) + "</span>";
    }
}

function crash() {
    isPlaying = false;
    document.getElementById('skyBg').classList.remove('sky-active');
    document.getElementById('multiNum').innerText = "üí• " + currentX.toFixed(2);
    document.getElementById('multiNum').style.color = "#ff4d4d";
    document.getElementById('rocket').innerText = "üí•";
    
    // L∆ØU L·ªäCH S·ª¨ L√äN FIREBASE
    db.ref('game_rocket_history').push({ x: parseFloat(currentX.toFixed(2)), time: Date.now() });

    setTimeout(() => {
        [1,2].forEach(n => {
            bets[n].active = false; bets[n].cashed = false;
            let b = document.getElementById('btn'+n);
            b.className = "btn-main btn-bet";
            b.innerHTML = "C∆Ø·ª¢C<span>V√≤ng t·ªõi</span>";
        });
        startWaiting();
    }, 2500);
}

// ADMIN FUNCTIONS
function toggleAdmin() {
    if(!userData.isAdmin && !userData.isSuperAdmin) return;
    let ov = document.getElementById('adminOverlay');
    ov.style.display = (ov.style.display === "block") ? "none" : "block";
}
function srvLock(s) { db.ref('server').update({ isLocked: s }); alert("ƒê√£ c·∫≠p nh·∫≠t!"); }
function toggleGameLock() {
    db.ref('game_rocket_settings/isLocked').once('value', s => {
        db.ref('game_rocket_settings').update({ isLocked: !s.val() });
        alert("ƒê√£ thay ƒë·ªïi tr·∫°ng th√°i game!");
    });
}

startWaiting();
</script>
</body>
</html>
