<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X√¨ D√°ch Imperial - V168 Master</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; user-select: none; }
        body { background: radial-gradient(circle at 50% 50%, #001a33 0%, #000 70%, #000 100%); color: #fff; font-family: 'Segoe UI', sans-serif; min-height: 100vh; overflow-x: hidden; }
        
        #syncLoading { height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; background: #000; position: fixed; inset: 0; z-index: 10000; padding: 20px; }
        .spinner { width: 50px; height: 50px; border: 5px solid #ffd70033; border-top: 5px solid #ffd700; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #gamePanel { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px; display: none; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 15px; border: 1px solid #ffd700; margin-bottom: 5px; }
        #money { font-size: 30px; color: #00ff41; font-weight: 900; text-align: center; margin: 10px 0; text-shadow: 0 0 15px #00ff41; }

        #localLockBanner { background: linear-gradient(90deg, #ff0000, #b71c1c); color: #fff; padding: 12px; text-align: center; font-weight: 900; border-radius: 15px; margin-bottom: 10px; border: 2px solid #fff; display: none; animation: blink 1s infinite alternate; font-size: 14px; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }
        
        .table-area { background: radial-gradient(circle, #004d00 0%, #002200 100%); border-radius: 100px 100px 20px 20px; border: 6px solid #5c4033; padding: 20px; min-height: 380px; position: relative; display: flex; flex-direction: column; justify-content: space-between; margin-bottom: 10px; box-shadow: inset 0 0 80px #000; }
        .hand { display: flex; justify-content: center; min-height: 100px; padding: 10px; }
        .card { width: 60px; height: 85px; background: #fff; border-radius: 6px; color: #000; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; font-weight: bold; font-size: 16px; border: 1px solid #999; box-shadow: 2px 2px 5px #000; margin-left: -25px; transition: 0.3s; animation: dealCard 0.4s ease-out; }
        @keyframes dealCard { from { transform: translateY(-100px) rotate(20deg); opacity: 0; } to { transform: translateY(0) rotate(0); opacity: 1; } }
        .card.red { color: #f00; }
        .card.hidden { background: linear-gradient(45deg, #1a0000 25%, #4a0000 50%, #1a0000 75%); border: 2px solid #ffd700; color: transparent; }
        .score-badge { background: rgba(0,0,0,0.6); padding: 3px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; color: #ffd700; border: 1px solid #ffd700; width: fit-content; margin: 5px auto; text-transform: uppercase; transition: 0.3s; }
        .thinking { color: #fff; border-color: #fff; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .btn { padding: 15px 5px; border-radius: 12px; border: none; font-weight: 900; font-size: 13px; cursor: pointer; text-transform: uppercase; transition: 0.2s; color: #fff; }
        .btn-hit { background: #2e7d32; }
        .btn-stand { background: #c62828; }
        .btn-double { background: #0277bd; }
        .btn-deal { background: linear-gradient(#ffd700, #b8860b); color: #000; grid-column: span 3; font-size: 18px; margin-top: 5px; }
        .btn:disabled { background: #333 !important; color: #666 !important; cursor: not-allowed; }

        #chipArea { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .chip { min-width: 52px; height: 52px; border-radius: 50%; border: 3px dashed #fff; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 10px; cursor: pointer; color: #fff; flex-shrink: 0; }
        .chip.active { border: 4px solid #ffd700; transform: translateY(-5px); box-shadow: 0 0 15px #ffd700; }

        #adminPanel { margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.95); border: 2px solid #ff0000; border-radius: 25px; display: none; }
        .admin-section { background: rgba(255,255,255,0.04); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        #sttLockDisplay { font-weight: 900; padding: 5px 15px; border-radius: 10px; margin-left: 10px; text-transform: uppercase; }

        #resultPopup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); border: 2px solid #ffd700; padding: 25px; border-radius: 20px; z-index: 100; text-align: center; display: none; min-width: 250px; }
        .slogan-boss { font-family: 'Impact', sans-serif; font-size: 13px; text-transform: uppercase; font-style: italic; color: #ffd700; text-align: center; margin-top: 10px; display: block; letter-spacing: 1px; }
        
        #historySection { background: rgba(0,0,0,0.6); border-radius: 15px; padding: 15px; border: 1px solid #333; margin-top: 15px; }
        .his-item { display: flex; flex-direction: column; padding: 8px 0; border-bottom: 1px solid #222; font-size: 12px; }
        .his-row { display: flex; justify-content: space-between; align-items: center; }
        .win { color: #00ff41; } .lose { color: #ff4d4d; } .draw { color: #ffd700; }
    </style>
</head>
<body>

<div id="syncLoading">
    <div class="spinner"></div>
    <p style="color:#ffd700; margin-top:20px; font-weight:900; letter-spacing:1px; white-space: nowrap; font-size: 12px;">ƒêANG K·∫æT N·ªêI ƒê·∫æN S√íNG B√ÄI IMPERIAL MASTER...</p>
</div>

<div id="gamePanel">
    <div class="header-bar">
        <button onclick="confirmExit()" style="background:#222;color:#ffd700;border:1px solid #ffd700;padding:5px 12px;border-radius:10px;font-size:11px;font-weight:bold;cursor:pointer;">‚Üê V·ªÄ S·∫¢NH</button>
        <div id="displayUser" style="color:#ffd700;font-weight:900;font-size:12px;">üë§ LOADING...</div>
    </div>

    <div id="localLockBanner">‚ö†Ô∏è H·ªÜ TH·ªêNG ƒêANG B·∫¢O TR√å ‚ö†Ô∏è</div>

    <div id="money">0 $</div>

    <div class="table-area">
        <div id="dealerSide">
            <div class="score-badge" id="dealerScore">Lowt9999</div>
            <div class="hand" id="dealerHand"></div>
        </div>
        <div id="resultPopup">
            <h1 id="popupTitle">TH·∫ÆNG!</h1>
            <h2 id="popupSub" style="color:#0f0">+1,000,000</h2>
        </div>
        <div id="playerSide">
            <div class="hand" id="playerHand"></div>
            <div class="score-badge" id="playerScore">B·∫†N: 0</div>
        </div>
    </div>

    <div id="betDisplay" style="text-align:center; color:#ffd700; font-weight:900; font-size:16px; margin-bottom:5px;">C∆Ø·ª¢C: 0 $</div>

    <div id="chipArea">
        <div class="chip active" data-value="1000" style="background:#1b5e20;">1K</div>
        <div class="chip" data-value="10000" style="background:#2e7d32;">10K</div>
        <div class="chip" data-value="100000" style="background:#fb8c00;">100K</div>
        <div class="chip" data-value="1000000" style="background:#0288d1;">1M</div>
        <div class="chip" data-value="1000000000" style="background:linear-gradient(#ffd700,#b8860b);color:#000;">1B</div>
        <div class="chip" data-value="1000000000000" style="background:linear-gradient(#ff1744,#d50000);">1T</div>
    </div>

    <div class="controls">
        <button id="btnHit" class="btn btn-hit" onclick="playerHit()" disabled>R√öT B√ÄI</button>
        <button id="btnDouble" class="btn btn-double" onclick="playerDouble()" disabled>C∆Ø·ª¢C TH√äM</button>
        <button id="btnStand" class="btn btn-stand" onclick="playerStand()" disabled>D·ª™NG B√ÄI</button>
        <button id="btnDeal" class="btn btn-deal" onclick="startGame()">V√ÅN M·ªöI</button>
    </div>

    <div id="adminPanel">
        <h2 style="color:#f00; text-align:center; font-size:16px; margin-bottom:15px; font-weight:900;">ADMIN IMPERIAL MASTER</h2>
        <div class="admin-section">
            <p style="font-size:11px; margin-bottom:10px;">TR·∫†NG TH√ÅI: <span id="sttLockDisplay">---</span></p>
            <div style="display:flex; gap:10px;">
                <button onclick="setLocalLock(true)" style="flex:1; background:#b71c1c; padding:10px; border-radius:8px; color:#fff; font-weight:900; border:none; cursor:pointer;">KH√ìA S√íNG</button>
                <button onclick="setLocalLock(false)" style="flex:1; background:#2e7d32; padding:10px; border-radius:8px; color:#fff; font-weight:900; border:none; cursor:pointer;">M·ªû S√íNG</button>
            </div>
        </div>
        <div class="admin-section">
            <p style="font-size:11px; margin-bottom:8px;">T·ªà L·ªÜ TH·∫ÆNG: <b id="curWR" style="color:#0f0;">--%</b> | √âP: <b id="curForce" style="color:#ffd700;">T·ª∞ NHI√äN</b></p>
            <div style="display:flex; gap:10px;">
                <input type="number" id="inpWR" style="width:60px; background:#000; color:#0f0; border:1px solid #333; padding:5px;" placeholder="%">
                <button onclick="saveWR()" style="flex:1; background:#ffd700; border:none; font-weight:900; cursor:pointer;">L∆ØU T·ªà L·ªÜ</button>
            </div>
        </div>
        <div id="sadOnly" style="display:none;">
            <div class="admin-section">
                <div style="display:flex; gap:5px;">
                    <button onclick="setForce('Th·∫Øng')" style="flex:1; background:#004d40; color:#fff; border:none; padding:8px; font-size:10px; cursor:pointer;">√âP TH·∫ÆNG</button>
                    <button onclick="setForce('Thua')" style="flex:1; background:#4a148c; color:#fff; border:none; padding:8px; font-size:10px; cursor:pointer;">√âP THUA</button>
                    <button onclick="setForce(null)" style="flex:1; background:#333; color:#fff; border:none; padding:8px; font-size:10px; cursor:pointer;">H·ª¶Y √âP</button>
                </div>
            </div>
            <div class="admin-section">
                <div id="adminUserList" style="max-height: 150px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <span class="slogan-boss">TR√ç TU·ªÜ B·∫¨C TH·∫¶Y - B·∫¢N Lƒ®NH ƒê·ªêI ƒê·∫¶U</span>
    <div id="historySection"><div id="historyContent"></div></div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyCbESIH8uq5Q6R45ehisGp-Lsh9xz_ejDk", authDomain: "tx888-85658.firebaseapp.com", databaseURL: "https://tx888-85658-default-rtdb.firebaseio.com", projectId: "tx888-85658", storageBucket: "tx888-85658.firebasestorage.app", messagingSenderId: "246211516842", appId: "1:246211516842:web:24a3598d54b037676c73d3" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database(), auth = firebase.auth();

let userData = null, selectedBet = 1000, currentBet = 0, isPlaying = false, isKicked = false;
let deck = [], playerHand = [], dealerHand = [], gameSettings = { winRate: 20, isLocked: false, forcedResult: null };
let currentTarget = null; 
let doubleClickCount = 0;

function formatMoney(n) {
    let num = Number(n);
    if (num >= 1000000000000000) return "‚àû";
    if (num >= 1000000000000) return Math.floor(num / 1000000000000) + "T";
    if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(".0", "") + "B";
    if (num >= 1000000) return (num / 1000000).toFixed(1).replace(".0", "") + "M";
    if (num >= 1000) return (num / 1000).toFixed(1).replace(".0", "") + "k";
    return num + " $";
}

function confirmExit() {
    if(confirm("ƒê·∫ø ch·∫ø ngh√¨n t·ª∑ ƒëang ƒë·ª£i ch·ªß nh√¢n, b·∫°n th·ª±c s·ª± mu·ªën r·ªùi b·ªè ngai v√†ng l√∫c n√†y sao?")) {
        window.location.href = 'index.html';
    }
}

auth.onAuthStateChanged(user => {
    if (user) {
        db.ref('users/' + user.uid).on('value', s => {
            userData = s.val(); if(!userData || isKicked) return;
            userData.uid = user.uid;
            document.getElementById("syncLoading").style.display = "none";
            document.getElementById("gamePanel").style.display = "block";
            document.getElementById("money").innerText = formatMoney(userData.money);
            document.getElementById("displayUser").innerText = "üë§ " + userData.username.toUpperCase();
            if(userData.isAdmin || userData.isSuperAdmin) {
                document.getElementById("adminPanel").style.display = "block";
                if(userData.isSuperAdmin) {
                    document.getElementById("sadOnly").style.display = "block";
                    db.ref('users').on('value', loadUserList);
                }
            }
            loadHistory();
        });
    } else location.href = "index.html";
});

db.ref('game_xidach_settings').on('value', s => {
    gameSettings = s.val() || { winRate: 20, isLocked: false, forcedResult: null };
    const banner = document.getElementById("localLockBanner");
    const lockText = document.getElementById("sttLockDisplay");
    const forceText = document.getElementById("curForce");
    if (banner) banner.style.display = gameSettings.isLocked ? "block" : "none";
    if (lockText) {
        lockText.innerText = gameSettings.isLocked ? "ƒê√É KH√ìA" : "ƒêANG M·ªû";
        lockText.style.background = gameSettings.isLocked ? "#b71c1c" : "#2e7d32";
    }
    if (forceText) forceText.innerText = gameSettings.forcedResult || "T·ª∞ NHI√äN";
    if (document.getElementById("curWR")) document.getElementById("curWR").innerText = gameSettings.winRate + "%";
});

function setLocalLock(s) { db.ref('game_xidach_settings').update({ isLocked: s }); }
function setForce(f) { db.ref('game_xidach_settings').update({ forcedResult: f }); }
function saveWR() { const v = parseInt(document.getElementById("inpWR").value); if(v>=0 && v<=100) db.ref('game_xidach_settings').update({ winRate: v }).then(() => alert("ƒê√£ l∆∞u!")); }

function loadUserList(snap) {
    let h = ""; const data = snap.val();
    let arr = Object.keys(data).map(id => ({id, ...data[id]})).sort((a,b)=>b.money - a.money);
    arr.forEach(u => {
        h += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span style="font-size:10px;">${u.username}</span><div>
        <button onclick="editMAdmin('${u.id}',1)" style="background:green;color:#fff;border:none;padding:2px 5px;border-radius:4px;cursor:pointer;">+1M</button>
        <button onclick="editMAdmin('${u.id}',-1)" style="background:red;color:#fff;border:none;padding:2px 5px;border-radius:4px;cursor:pointer;">-1M</button>
        </div></div>`;
    });
    document.getElementById("adminUserList").innerHTML = h;
}
function editMAdmin(id, t) { db.ref('users/'+id+'/money').once('value', s => { db.ref('users/'+id).update({ money: Math.max(0, s.val() + (t*1000000)) }); }); }

function createDeck() {
    const suits = ['‚ô†','‚ô£','‚ô•','‚ô¶'], values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    let d = []; for(let s of suits) for(let v of values) d.push({suit: s, value: v, color: (s==='‚ô•'||s==='‚ô¶')?'red':'black'});
    return d.sort(() => Math.random() - 0.5);
}

function cheatPop(targetType, currentScore, opponentScore) {
    let foundIdx = -1;
    let safeIdx = -1;
    let minVal = 99;

    for (let i = deck.length - 1; i >= 0; i--) {
        let card = deck[i];
        let val = (card.value === 'A') ? 1 : (['J', 'Q', 'K'].includes(card.value) ? 10 : parseInt(card.value));
        let potentialScore = currentScore + val;

        if (targetType === 'DealerWin') {
            if (potentialScore >= opponentScore && potentialScore <= 21) { foundIdx = i; break; }
            if (potentialScore <= 21 && val < minVal) { minVal = val; safeIdx = i; }
        } else if (targetType === 'DealerLose') {
            if (potentialScore > 21 || potentialScore < opponentScore) { foundIdx = i; break; }
        }
    }
    if (foundIdx === -1 && targetType === 'DealerWin' && safeIdx !== -1) foundIdx = safeIdx;
    if (foundIdx !== -1) {
        let chosen = deck.splice(foundIdx, 1)[0];
        deck.push(chosen);
    }
    return deck.pop();
}

function getScore(hand) {
    let s = 0, a = 0;
    for(let c of hand) { if(c.value==='A') a++; else if(['J','Q','K'].includes(c.value)) s+=10; else s+=parseInt(c.value); }
    for(let i=0; i<a; i++) s += (s+11<=21) ? 11 : 1;
    return s;
}

function checkSpecial(hand) {
    if(hand.length!==2) return null;
    if(hand[0].value==='A' && hand[1].value==='A') return "X√¨ B√†n";
    if((hand[0].value==='A'&&['10','J','Q','K'].includes(hand[1].value))||(hand[1].value==='A'&&['10','J','Q','K'].includes(hand[0].value))) return "X√¨ D√°ch";
    return null;
}

function startGame() {
    if(gameSettings.isLocked && !userData.isAdmin && !userData.isSuperAdmin) return;
    if(isPlaying || userData.money < selectedBet) return alert("Kh√¥ng ƒë·ªß ti·ªÅn!");
    
    isPlaying = true; currentBet = selectedBet;
    doubleClickCount = 0;
    db.ref('users/'+userData.uid).update({ money: userData.money - currentBet });
    document.getElementById("betDisplay").innerText = "C∆Ø·ª¢C: " + formatMoney(currentBet);
    document.getElementById("resultPopup").style.display = "none";
    
    deck = createDeck();
    
    if (gameSettings.forcedResult === "Th·∫Øng") currentTarget = "Th·∫Øng";
    else if (gameSettings.forcedResult === "Thua") currentTarget = "Thua";
    else currentTarget = (Math.random() * 100 < gameSettings.winRate) ? "Th·∫Øng" : "Thua";

    playerHand = [deck.pop(), deck.pop()];
    dealerHand = [deck.pop(), deck.pop()];

    renderHands(false); updateButtons();
    
    let pS = checkSpecial(playerHand), dS = checkSpecial(dealerHand);
    if(dS || pS) {
        setTimeout(() => {
            document.getElementById("dealerScore").innerText = "ƒêANG SUY NGHƒ®...";
            setTimeout(() => endGame(pS, dS), 1500);
        }, 800);
    }
}

function renderHands(f) {
    const pA = document.getElementById("playerHand"), dA = document.getElementById("dealerHand");
    pA.innerHTML = ""; dA.innerHTML = "";
    playerHand.forEach(c => pA.innerHTML += `<div class="card ${c.color}">${c.value}<br>${c.suit}</div>`);
    dealerHand.forEach((c, i) => { 
        if(i===0 && !f) dA.innerHTML += `<div class="card hidden"></div>`; 
        else dA.innerHTML += `<div class="card ${c.color}">${c.value}<br>${c.suit}</div>`; 
    });
    document.getElementById("playerScore").innerText = "B·∫†N: " + getScore(playerHand);
    if(!f) document.getElementById("dealerScore").innerText = "Lowt9999: ?";
}

function playerHit() {
    if(!isPlaying || playerHand.length >= 5) return;
    playerHand.push(deck.pop());
    let pS = getScore(playerHand);
    renderHands(false);
    if(pS > 21) {
        updateButtons(true);
        setTimeout(() => dealerFinalTurn(), 800);
    }
    else if (playerHand.length === 5) setTimeout(() => playerStand(), 500);
}

function playerDouble() {
    if(userData.money < currentBet) return alert("Kh√¥ng ƒë·ªß ti·ªÅn!");
    db.ref('users/' + userData.uid).update({ money: userData.money - currentBet });
    currentBet *= 2;
    document.getElementById("betDisplay").innerText = "C∆Ø·ª¢C: " + formatMoney(currentBet);
    doubleClickCount++;
    let extraRisk = doubleClickCount * 20;
    if(Math.random() * 100 < extraRisk) currentTarget = "Thua";
}

function playerStand() { dealerFinalTurn(); }

function dealerFinalTurn() {
    updateButtons(true);
    const dealerBadge = document.getElementById("dealerScore");
    
    const draw = () => {
        renderHands(true);
        let pS = getScore(playerHand), dS = getScore(dealerHand);
        
        let shouldDraw = false;
        let cardToDraw = null;

        if (currentTarget === "Thua") {
            if (pS <= 21 && dS < pS && dS < 21 && dealerHand.length < 5) {
                shouldDraw = true;
                cardToDraw = cheatPop('DealerWin', dS, pS);
            }
        } else {
            if (dS < 17 && dealerHand.length < 5) {
                shouldDraw = true;
                cardToDraw = cheatPop('DealerLose', dS, pS);
            }
        }

        if(shouldDraw) {
            dealerBadge.innerText = "ƒêANG SUY NGHƒ®...";
            dealerBadge.classList.add("thinking");
            
            setTimeout(() => {
                dealerBadge.classList.remove("thinking");
                dealerHand.push(cardToDraw || deck.pop());
                renderHands(true);
                let newDS = getScore(dealerHand);
                dealerBadge.innerText = "Lowt9999: " + newDS;
                
                if (newDS > 21) setTimeout(() => endGame(), 800);
                else draw();
            }, 1500); // TƒÉng th·ªùi gian suy nghƒ© ch√¢n th·ª±c
        } else {
            dealerBadge.innerText = "Lowt9999: " + dS;
            setTimeout(() => endGame(), 800);
        }
    };
    draw();
}

function endGame(pSp, dSp) {
    renderHands(true);
    let pS = getScore(playerHand), dS = getScore(dealerHand), status = "", winM = 0, type = "ƒêi·ªÉm th∆∞·ªùng";
    let pN = (playerHand.length === 5 && pS <= 21);
    let dN = (dealerHand.length === 5 && dS <= 21);

    if(pSp || dSp) {
        if(pSp === dSp) status = "H√≤a";
        else if(dSp === "X√¨ B√†n") { status = "Thua"; type = "C√°i X√¨ B√†n"; }
        else if(pSp === "X√¨ B√†n") { status = "Th·∫Øng"; winM = 2; type = "X√¨ B√†n"; }
        else if(dSp === "X√¨ D√°ch") { status = "Thua"; type = "C√°i X√¨ D√°ch"; }
        else if(pSp === "X√¨ D√°ch") { status = "Th·∫Øng"; winM = 2; type = "X√¨ D√°ch"; }
    } else if (pS > 21) { status = "Thua"; type = "Qu·∫Øc"; }
    else if (dN) { status = "Thua"; type = "C√°i Ng≈© Linh"; }
    else if (pN) { status = "Th·∫Øng"; winM = 3; type = "Ng≈© Linh x3"; }
    else if (dS > 21) { status = "Th·∫Øng"; winM = 2; type = "C√°i Qu·∫Øc"; }
    else if (pS > dS) { status = "Th·∫Øng"; winM = 2; type = "ƒêi·ªÉm cao"; }
    else if (pS === dS) status = "H√≤a";
    else status = "Thua";

    let resA = 0;
    if(status === "Th·∫Øng") { 
        resA = currentBet * winM; 
        db.ref('users/'+userData.uid).update({ money: userData.money + resA }); 
    } else if(status === "H√≤a") { 
        resA = currentBet; 
        db.ref('users/'+userData.uid).update({ money: userData.money + resA }); 
    }

    showPopup(status, status === "Th·∫Øng" ? resA : currentBet);
    saveHistory(status, status === "Th·∫Øng" ? resA : currentBet, pS, dS, type);
    isPlaying = false; updateButtons();
}

function showPopup(s, a) {
    const pop = document.getElementById("resultPopup"), t = document.getElementById("popupTitle"), sb = document.getElementById("popupSub");
    pop.style.display = "block"; t.innerText = s.toUpperCase() + "!";
    if(s === "Th·∫Øng") t.style.color = "#0f0";
    else if(s === "H√≤a") t.style.color = "#ffd700";
    else t.style.color = "#f00";
    sb.innerText = (s === "Th·∫Øng" ? "+" : (s === "H√≤a" ? "" : "-")) + formatMoney(a);
    sb.style.color = t.style.color;
    setTimeout(() => pop.style.display = "none", 3500);
}

function updateButtons(f = false) {
    document.getElementById("btnHit").disabled = f || !isPlaying || playerHand.length >= 5;
    document.getElementById("btnStand").disabled = f || !isPlaying;
    document.getElementById("btnDouble").disabled = f || !isPlaying;
    document.getElementById("btnDeal").disabled = isPlaying;
}

function saveHistory(r, a, p, d, t) {
    const ref = db.ref('users/' + userData.uid + '/history_xidach');
    ref.once('value', s => { 
        let l = s.val() || []; 
        l.unshift({ res: r, amt: a, pScore: p, dScore: d, type: t, time: Date.now() }); 
        ref.set(l.slice(0, 10)); 
    });
}

function loadHistory() {
    db.ref('users/' + userData.uid + '/history_xidach').on('value', s => {
        let h = ""; (s.val() || []).forEach(i => {
            let resClass = i.res==='Th·∫Øng' ? 'win' : (i.res==='H√≤a' ? 'draw' : 'lose');
            h += `<div class="his-item"><div class="his-row"><span><b>${i.type}</b> (${i.pScore} vs ${i.dScore})</span><span class="${resClass}">${i.res} ${i.res==='Th·∫Øng'?'+':(i.res==='H√≤a'?'':'-')}${formatMoney(i.amt)}</span></div></div>`;
        });
        document.getElementById("historyContent").innerHTML = h || "<div style='text-align:center;color:#666;font-size:10px;'>CH∆ØA C√ì D·ªÆ LI·ªÜU</div>";
    });
}

document.querySelectorAll(".chip").forEach(c => {
    c.onclick = function() { if(isPlaying) return; document.querySelectorAll(".chip").forEach(el => el.classList.remove("active")); this.classList.add("active"); selectedBet = parseInt(this.dataset.value); }
});
</script>
</body>
</html>
