<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Casino - V149 Master Lobby</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        /* GI·ªÆ NGUY√äN 100% CSS T·ª™ C√ÅC PHI√äN B·∫¢N TR∆Ø·ªöC - KH√îNG L∆Ø·ª¢C B·ªé */
        * { box-sizing: border-box; -webkit-tap-highlight-color: rgba(0,0,0,0); outline: none; margin: 0; padding: 0; }
        html, body { background-color: #000; background-image: radial-gradient(circle at 50% 50%, #4a0000 0%, #2a0000 45%, #000 100%); background-attachment: fixed; color: #fff; font-family: 'Segoe UI', Tahoma, sans-serif; overflow-x: hidden; min-height: 100vh; }
        #loginPanel, #lobbyPanel { width: 100%; max-width: 500px; margin: 0 auto; padding: 25px 20px; }
        .login-card { background-color: rgba(10, 10, 10, 0.98); padding: 55px 35px; border-radius: 50px; border: 2px solid rgba(255, 215, 0, 0.4); text-align: center; box-shadow: 0 40px 100px #000; }
        
        #logStatusText { color: #ffd700; font-size: 10px; margin-bottom: 30px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; animation: blink-log 2s infinite; min-height: 20px; display: flex; align-items: center; justify-content: center; white-space: nowrap; }
        @keyframes blink-log { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        .sad-input { width: 100%; padding: 20px; background-color: #050505; border: 1px solid #333; color: #fff; border-radius: 20px; margin-bottom: 15px; font-size: 16px; }
        .btn-main { width: 100%; padding: 24px; background-image: linear-gradient(135deg, #ffd700 0%, #b8860b 100%); color: #000; font-weight: 900; font-size: 20px; border-radius: 20px; border: none; cursor: pointer; text-transform: uppercase; }
        
        .marquee-box { width: 100%; background: rgba(255, 215, 0, 0.08); border: 1px solid rgba(255, 215, 0, 0.25); border-radius: 20px; padding: 14px 0; margin-bottom: 25px; overflow: hidden; }
        .marquee-text { display: inline-block; white-space: nowrap; color: #ffd700; font-size: 15px; font-weight: 900; animation: marquee-run 16s linear infinite; }
        @keyframes marquee-run { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        #lockBanner { background: linear-gradient(to right, #b71c1c, #ff0000); color: #fff; padding: 18px; text-align: center; font-weight: 900; border-radius: 25px; border: 2px solid #fff; margin-bottom: 25px; display: none; box-shadow: 0 0 30px rgba(255,0,0,0.6); }
        
        #gameListContainer { display: flex; flex-direction: column; }
        .btn-play-card { position: relative; padding: 45px 10px; border-radius: 45px; border: 2px solid rgba(255, 215, 0, 0.35); cursor: pointer; margin-bottom: 25px; text-align: center; background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), transparent); overflow: hidden; transition: 0.3s; order: 3; }
        
        .btn-play-card h3 { white-space: nowrap; transition: 0.2s; }
        .maint-mode h3 { font-size: 13.5px !important; }
        .maint-mode { filter: grayscale(1) brightness(0.6) !important; opacity: 0.5 !important; pointer-events: none; }

        .badge-hot { position: absolute; top: 15px; right: 15px; background: #ff0000; color: #fff; font-size: 10px; font-weight: 900; padding: 5px 12px; border-radius: 10px; animation: pulse-hot 1s infinite; }
        .badge-new { position: absolute; top: 15px; right: 15px; background: #4caf50; color: #fff; font-size: 10px; font-weight: 900; padding: 5px 12px; border-radius: 10px; animation: pulse-hot 1s infinite; }
        .badge-soon { position: absolute; top: 15px; right: 15px; background: #555; color: #fff; font-size: 10px; font-weight: 900; padding: 5px 12px; border-radius: 10px; }
        @keyframes pulse-hot { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .slogan-ultimate { color: #999; font-size: 3.2vw; max-font-size: 13px; margin-top: 15px; font-style: italic; font-weight: 800; white-space: nowrap; display: block; width: 100%; text-transform: uppercase; }
        
        .sad-dashboard { background: rgba(0, 0, 0, 0.99); border: 2px solid #ff0000; border-radius: 50px; padding: 30px 15px; margin-top: 40px; margin-bottom: 100px; box-shadow: 0 0 50px rgba(255,0,0,0.5); display: none; }
        .user-item-card { background: rgba(255, 255, 255, 0.02); padding: 18px; border-radius: 25px; margin-bottom: 15px; border: 1px solid #222; }
        .control-grid { display: grid; grid-template-columns: 1.4fr 1fr 1fr 1fr 1fr; gap: 6px; margin-top: 12px; }
        .btn-mini { height: 42px; border-radius: 12px; border: none; font-size: 14px; font-weight: 900; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; text-transform: uppercase; }
        .role-badge { font-size: 9px; padding: 4px 10px; border-radius: 6px; font-weight: 900; text-transform: uppercase; margin-left: 10px; display: inline-block; }
        .role-sad { background: #f00; color: #fff; border: 1px solid #fff; }
        .role-ad { background: #ffd700; color: #000; }
        .role-mem { background: #2196f3; color: #fff; }
        .admin-tag-stt { font-size: 11px; color: #ffd700; display: block; margin-bottom: 8px; font-weight: 900; text-transform: uppercase; }
        .btn-tag-cmd { flex: 1; height: 35px; border-radius: 8px; border: none; font-size: 9px; font-weight: 900; color: #fff; cursor: pointer; }

        @keyframes glowVoCuc { 0% { background-position: 0% 50%; box-shadow: 0 0 10px #ff0000; } 50% { background-position: 100% 50%; box-shadow: 0 0 30px #00ff00; } 100% { background-position: 0% 50%; box-shadow: 0 0 10px #ff0000; } }
        @keyframes glowRed { 0%, 100% { box-shadow: inset 0 0 5px #ff3d00, 0 0 5px #ff3d00; } 50% { box-shadow: inset 0 0 15px #ff3d00, 0 0 15px #ff3d00; } }
        @keyframes glowPurple { 0%, 100% { box-shadow: inset 0 0 5px #d500f9, 0 0 5px #d500f9; } 50% { box-shadow: inset 0 0 15px #d500f9, 0 0 15px #d500f9; } }
        @keyframes glowYellow { 0%, 100% { box-shadow: inset 0 0 5px #ffea00, 0 0 5px #ffea00; } 50% { box-shadow: inset 0 0 15px #ffea00, 0 0 15px #ffea00; } }
        @keyframes glowGreen { 0%, 100% { box-shadow: inset 0 0 5px #00e676, 0 0 5px #00e676; } 50% { box-shadow: inset 0 0 15px #00e676, 0 0 15px #00e676; } }
        @keyframes glowBlue { 0%, 100% { box-shadow: inset 0 0 5px #00e5ff, 0 0 5px #00e5ff; } 50% { box-shadow: inset 0 0 15px #00e5ff, 0 0 15px #00e5ff; } }

        .rank-vocuc-item { background: linear-gradient(-45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8); background-size: 400% 400%; animation: glowVoCuc 3s ease infinite; border: 2px solid #fff !important; transform: scale(1.03); z-index: 10; }
        .rank-vocuc-item * { color: #fff !important; text-shadow: 2px 2px 4px #000; font-weight: 900 !important; }
        .rank-do-kiep { animation: glowRed 2s infinite; border: 1px solid #ff3d00 !important; }
        .rank-hop-the { animation: glowPurple 2s infinite; border: 1px solid #d500f9 !important; }
        .rank-luyen-hu { animation: glowYellow 2s infinite; border: 1px solid #ffea00 !important; }
        .rank-hoa-than { animation: glowGreen 3s infinite; border: 1px solid #00e676 !important; }
        .rank-nguyen-anh { animation: glowBlue 3s infinite; border: 1px solid #00e5ff !important; }
        .tu-vi-tag { font-size: 9px; font-weight: 900; padding: 2px 8px; border-radius: 5px; margin-top: 5px; display: inline-block; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="loginPanel">
    <div class="login-card">
        <h1 style="color:#ffd700; text-transform: uppercase; letter-spacing: 5px; margin-bottom: 8px; font-size: 32px;">Royal Casino</h1>
        <div id="logStatusText">ƒêANG KH·ªûI T·∫†O LI√äN K·∫æT ƒê·∫æ CH·∫æ...</div>
        <div id="authForm" style="display:none;">
            <input type="text" id="username" class="sad-input" placeholder="T√™n t√†i kho·∫£n">
            <input type="password" id="password" class="sad-input" placeholder="M·∫≠t kh·∫©u (√≠t nh·∫•t 6 k√Ω t·ª±)">
            <button onclick="register()" class="btn-main">ƒêƒÇNG K√ù NH·∫¨N 1M$</button>
            <button onclick="login()" style="width:100%; padding:18px; background:none; color:#555; border:none; cursor:pointer; margin-top:20px; font-weight:bold;">ƒê√É C√ì T√ÄI KHO·∫¢N? ƒêƒÇNG NH·∫¨P</button>
        </div>
    </div>
</div>

<div id="lobbyPanel" style="display:none;">
    <div class="marquee-box"><div id="marqueeText" class="marquee-text">Ch√†o m·ª´ng qu√Ω kh√°ch ƒë·∫øn v·ªõi Royal Casino!</div></div>
    <div id="lockBanner">‚ö†Ô∏è M√ÅY CH·ª¶ ƒêANG B·∫¢O TR√å - TR√í CH∆†I T·∫†M KH√ìA ‚ö†Ô∏è</div>

    <div style="padding:40px 20px; border-radius:50px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,215,0,0.3); margin-bottom:35px; text-align:center;">
        <div id="myRankDisplay" class="role-badge">MEMBER</div>
        <h2 id="lobbyName" style="color:#ffd700; margin-top:10px; margin-bottom:15px; font-size:30px; font-weight:900;">--</h2>
        <div id="lobbyMoney" style="font-size:38px; color:#4caf50; font-weight:900; margin-bottom:30px;">S·ªë d∆∞: 0 $</div>
        <button onclick="logout()" style="background:rgba(204,0,0,0.15); color:#ff5252; border:1px solid #ff5252; padding:15px 40px; border-radius:22px; font-weight:bold; cursor:pointer;">ƒêƒÇNG XU·∫§T</button>
    </div>

    <div style="background: rgba(10, 10, 10, 0.99); border: 2px solid #ffd700; border-radius: 45px; padding: 35px 20px; margin-bottom: 40px; box-shadow: 0 0 30px rgba(255,215,0,0.1);">
        <h3 style="color:#ffd700; text-align:center; margin-top:0; font-size:18px; border-bottom:1px solid #333; padding-bottom:22px; text-transform:uppercase; letter-spacing:3px;">üèÜTi√™n B·∫£ng Ch√≠ T√¥nüèÜ</h3>
        <div id="top10List"></div>
    </div>

    <div id="gameListContainer">
        <div id="btnTX" onclick="enterGame('index2.html', 'tx')" class="btn-play-card"><div id="badge_tx"></div><div style="font-size:75px; margin-bottom:15px;">üé≤</div><h3 id="title_tx" style="color: #ffd700; margin: 0; font-size: 26px; font-weight: 900; letter-spacing: 3px;">T√ÄI X·ªàU IMPERIAL</h3><span id="slogan_tx" class="slogan-ultimate">N∆†I ANH H√ôNG H·ªòI T·ª§ - B·∫¢N Lƒ®NH ƒê·ªäNH GIANG S∆†N</span></div>
        <div id="btnXDach" onclick="enterGame('index4.html', 'xdach')" class="btn-play-card"><div id="badge_xdach"></div><div style="font-size:75px; margin-bottom:15px;">üÉè</div><h3 id="title_xdach" style="color: #ffd700; margin: 0; font-size: 26px; font-weight: 900; letter-spacing: 3px;">X√å D√ÅCH IMPERIAL</h3><span id="slogan_xdach" class="slogan-ultimate">TR√ç TU·ªÜ B·∫¨C TH·∫¶Y - ƒê·∫≤NG C·∫§P QU√ÇN B√ÄI</span></div>
        <div id="btnXD" onclick="enterGame('index3.html', 'xd')" class="btn-play-card"><div id="badge_xd"></div><div style="font-size:75px; margin-bottom:15px;">‚ö™üî¥</div><h3 id="title_xd" style="color: #ffd700; margin: 0; font-size: 26px; font-weight: 900; letter-spacing: 3px;">X√ìC ƒêƒ®A IMPERIAL</h3><span id="slogan_xd" class="slogan-ultimate">HUY·ªÄN THO·∫†I ƒê·∫æ CH·∫æ - UY CH·∫§N SERVER</span></div>
        <div id="btnRC" onclick="enterGame('index5.html', 'rc')" class="btn-play-card"><div id="badge_rc"></div><div style="font-size:75px; margin-bottom:15px;">üöÄ</div><h3 id="title_rc" style="color: #ffd700; margin: 0; font-size: 26px; font-weight: 900; letter-spacing: 3px;">ROCKET CRASH</h3><span id="slogan_rc" class="slogan-ultimate">PHI THUY·ªÄN T·ªêC ƒê·ªò - TO·∫† ƒê·ªò L√ÄM GI√ÄU</span></div>
        <div id="btnSoon" class="btn-play-card" style="opacity: 0.6; cursor: default; filter: grayscale(1); order: 999;">
            <div class="badge-soon">COMING SOON</div>
            <div style="font-size:75px; margin-bottom:15px;">üíé</div>
            <h3 style="color: #ffd700; margin: 0; font-size: 26px; font-weight: 900; letter-spacing: 3px;">BACCARAT ROYAL</h3>
            <span class="slogan-ultimate">S·∫ÆP RA M·∫ÆT - ƒê√ìN CH·ªú TR·∫¢I NGHI·ªÜM M·ªöI</span>
        </div>
    </div>

    <div id="sadDashboard" class="sad-dashboard">
        <div style="color:#f00; font-weight:900; text-align:center; margin-bottom:35px; font-size:22px; text-transform:uppercase;">Master Control Center</div>
        <div style="background: rgba(255,255,255,0.03); padding: 25px 20px; border-radius: 35px; border: 1px solid #333; margin-bottom: 25px;">
            <div style="text-align:center; color:#ffd700; font-size:12px; font-weight:bold; margin-bottom:20px; text-transform:uppercase;">QU·∫¢N L√ù GAME (SAD)</div>
            <div id="admin_game_ctrl_area">
                <div id="ctrl_row_tx" style="margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:10px;"><span id="stt_tx_admin" class="admin-tag-stt">T√ÄI X·ªàU: [---]</span><div style="display:flex; gap:5px;"><button onclick="setTag('tx','hot')" class="btn-tag-cmd" style="background:#f00;">HOT</button><button onclick="setTag('tx','new')" class="btn-tag-cmd" style="background:#4caf50;">NEW</button><button onclick="setTag('tx','none')" class="btn-tag-cmd" style="background:#555;">NONE</button><button id="btn_maint_tx" onclick="toggleMaint('tx')" class="btn-tag-cmd" style="flex:1.5;">---</button></div></div>
                <div id="ctrl_row_xdach" style="margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:10px;"><span id="stt_xdach_admin" class="admin-tag-stt">X√å D√ÅCH: [---]</span><div style="display:flex; gap:5px;"><button onclick="setTag('xdach','hot')" class="btn-tag-cmd" style="background:#f00;">HOT</button><button onclick="setTag('xdach','new')" class="btn-tag-cmd" style="background:#4caf50;">NEW</button><button onclick="setTag('xdach','none')" class="btn-tag-cmd" style="background:#555;">NONE</button><button id="btn_maint_xdach" onclick="toggleMaint('xdach')" class="btn-tag-cmd" style="flex:1.5;">---</button></div></div>
                <div id="ctrl_row_xd" style="margin-bottom:15px; border-bottom:1px solid #222; padding-bottom:10px;"><span id="stt_xd_admin" class="admin-tag-stt">X√ìC ƒêƒ®A: [---]</span><div style="display:flex; gap:5px;"><button onclick="setTag('xd','hot')" class="btn-tag-cmd" style="background:#f00;">HOT</button><button onclick="setTag('xd','new')" class="btn-tag-cmd" style="background:#4caf50;">NEW</button><button onclick="setTag('xd','none')" class="btn-tag-cmd" style="background:#555;">NONE</button><button id="btn_maint_xd" onclick="toggleMaint('xd')" class="btn-tag-cmd" style="flex:1.5;">---</button></div></div>
                <div id="ctrl_row_rc" style="margin-bottom:10px;"><span id="stt_rc_admin" class="admin-tag-stt">ROCKET: [---]</span><div style="display:flex; gap:5px;"><button onclick="setTag('rc','hot')" class="btn-tag-cmd" style="background:#f00;">HOT</button><button onclick="setTag('rc','new')" class="btn-tag-cmd" style="background:#4caf50;">NEW</button><button onclick="setTag('rc','none')" class="btn-tag-cmd" style="background:#555;">NONE</button><button id="btn_maint_rc" onclick="toggleMaint('rc')" class="btn-tag-cmd" style="flex:1.5;">---</button></div></div>
            </div>
        </div>
        <div style="background: rgba(255,255,255,0.03); padding: 30px 20px; border-radius: 35px; border: 1px solid #333; margin-bottom: 35px;">
            <div id="srvStatusDisp" style="text-align:center; font-size:12px; font-weight:900; padding:12px; border-radius:15px; margin-bottom:20px; text-transform:uppercase;">SERVER: --</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;"><button onclick="srvLock(true)" class="btn-mini" style="flex:1; height:50px; background:#b71c1c;">KH√ìA M√ÅY</button><button onclick="srvLock(false)" class="btn-mini" style="flex:1; height:50px; background:#2e7d32;">M·ªû M√ÅY</button></div>
            <input type="text" id="newNotice" class="sad-input" style="font-size:14px;" placeholder="Th√¥ng b√°o m·ªõi..."><button onclick="updateNotice()" style="width:100%; background:#1565c0; color:#fff; border:none; padding:20px; border-radius:20px; font-weight:bold;">C·∫¨P NH·∫¨T TO√ÄN SERVER</button>
        </div>
        <div id="masterUserList"></div>
    </div>
</div>

<script>
/** * FIREBASE CONFIGURATION & INITIALIZATION 
 * Gi·ªØ nguy√™n c√°c th√¥ng tin k·∫øt n·ªëi v√† bi·∫øn to√†n c·ª•c c·ªßa S·∫£nh 3
 */
const firebaseConfig = { apiKey: "AIzaSyCbESIH8uq5Q6R45ehisGp-Lsh9xz_ejDk", authDomain: "tx888-85658.firebaseapp.com", databaseURL: "https://tx888-85658-default-rtdb.firebaseio.com", projectId: "tx888-85658", storageBucket: "tx888-85658.firebasestorage.app", messagingSenderId: "246211516842", appId: "1:246211516842:web:24a3598d54b037676c73d3" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database(), auth = firebase.auth();
let userData = null, isServerLocked = false, inputCache = {}, gameMaintStatus = {};

/**
 * H√ÄM ƒê·ªäNH D·∫†NG TI·ªÄN T·ªÜ (MONEY FORMATTER)
 */
function formatMoney(n) {
    let num = Number(n);
    if (num >= 1000000000000000) return "‚àû ";
    if (num >= 1000000000000) return (num / 1000000000000).toFixed(1) + "T";
    if (num >= 1000000000) return (num / 1000000000).toFixed(1) + "B";
    if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "k";
    return num + " $";
}

/**
 * H√ÄM L·∫§Y ƒê∆Ø·ªúNG D·∫™N DATABASE C·ª¶A T·ª™NG GAME
 */
const getPath = (id) => {
    if(id === 'tx') return 'game_taixiu_settings';
    if(id === 'xdach') return 'game_xidach_settings';
    if(id === 'xd') return 'game_xocdia_settings';
    if(id === 'rc') return 'game_rocket_settings';
};

/**
 * H√ÄM L·∫§Y T√äN HI·ªÇN TH·ªä C·ª¶A T·ª™NG GAME
 */
const getName = (id) => {
    if(id === 'tx') return 'T√ÄI X·ªàU';
    if(id === 'xdach') return 'X√å D√ÅCH';
    if(id === 'xd') return 'X√ìC ƒêƒ®A';
    if(id === 'rc') return 'ROCKET';
};

/**
 * H√ÄM V√ÄO TR√í CH∆†I (ENTER GAME)
 * Ki·ªÉm tra tr·∫°ng th√°i b·∫£o tr√¨ c·ªßa server v√† t·ª´ng game c·ª• th·ªÉ
 */
function enterGame(url, gameId) {
    db.ref(getPath(gameId) + '/isLocked').once('value', s => {
        if ((isServerLocked || s.val()) && !userData.isSuperAdmin && !userData.isAdmin) {
            alert("M√ÅY CH·ª¶ ƒêANG B·∫¢O TR√å!");
        } else { window.location.href = url; }
    });
}

/**
 * C√ÅC H√ÄM D√ÄNH CHO ADMIN & SUPER ADMIN
 */
function setTag(id, tag) { db.ref('server/game_settings/' + id).update({ tag: tag }); }
function toggleMaint(id) {
    const path = getPath(id);
    db.ref(path + '/isLocked').once('value', s => { db.ref(path).update({ isLocked: !s.val() }); });
}
function srvLock(s) { db.ref('server').update({ isLocked: s }); }
function updateNotice() { const n = document.getElementById("newNotice").value; if(n) db.ref('server').update({ notice: n }); }
function toggleAD(id, c) { db.ref('users/'+id).update({ isAdmin: !c }); }
function delN(id) { if(confirm("X√≥a vƒ©nh vi·ªÖn?")) db.ref('users/'+id).remove(); }
function editM(id, t) {
    const f = document.getElementById("amt_" + id); const v = parseInt(f.value);
    if (isNaN(v) || v <= 0) return;
    db.ref('users/' + id + '/money').once('value', snap => {
        db.ref('users/' + id).update({ money: Math.max(0, snap.val() + (t * v)) });
    }).then(() => { f.value = ""; inputCache[id] = ""; });
}

/**
 * H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN GAME (UI REFRESH)
 */
function refreshUI() {
    ['tx', 'xdach', 'xd', 'rc'].forEach(id => {
        const btnId = id==='tx'?'btnTX':(id==='xdach'?'btnXDach':(id==='xd'?'btnXD':'btnRC'));
        const elBtn = document.getElementById(btnId);
        const title = document.getElementById('title_'+id);
        const isGameLocked = gameMaintStatus[id] || false;
        if(elBtn && title) {
            if(isServerLocked || isGameLocked) { elBtn.classList.add('maint-mode'); title.innerText = "B·∫¢O TR√å"; }
            else { elBtn.classList.remove('maint-mode'); title.innerText = getName(id) + (id==='rc'?' CRASH':' IMPERIAL'); }
        }
    });
}

/**
 * H√ÄM L·∫ÆNG NGHE S·ª∞ KI·ªÜN T·ª™ DATABASE (EVENT LISTENERS)
 */
function startListeners() {
    ['tx', 'xdach', 'xd', 'rc'].forEach(id => {
        const btnId = id==='tx'?'btnTX':(id==='xdach'?'btnXDach':(id==='xd'?'btnXD':'btnRC'));
        const elBtn = document.getElementById(btnId);
        db.ref('server/game_settings/' + id + '/tag').on('value', s => {
            const tag = s.val() || 'none';
            const badge = document.getElementById('badge_'+id);
            if(badge) {
                badge.className = (tag==='hot'?'badge-hot':(tag==='new'?'badge-new':''));
                badge.innerText = (tag==='none'?'':tag.toUpperCase());
            }
            if(elBtn) {
                if(tag === 'hot') elBtn.style.order = "1";
                else if(tag === 'new') elBtn.style.order = "2";
                else elBtn.style.order = "3";
            }
            updateAdminSTT(id);
        });
        db.ref(getPath(id) + '/isLocked').on('value', s => {
            gameMaintStatus[id] = s.val() || false;
            const maintBtn = document.getElementById('btn_maint_'+id);
            if(maintBtn) {
                maintBtn.innerText = gameMaintStatus[id] ? "M·ªû GAME" : "KH√ìA GAME";
                maintBtn.style.background = gameMaintStatus[id] ? "#2e7d32" : "#b71c1c";
            }
            refreshUI();
            updateAdminSTT(id);
        });
    });
}

/**
 * C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI TRONG B·∫¢NG ƒêI·ªÄU KHI·ªÇN ADMIN
 */
function updateAdminSTT(id) {
    const el = document.getElementById('stt_'+id+'_admin'); if(!el) return;
    db.ref('server/game_settings/'+id+'/tag').once('value', t => {
        db.ref(getPath(id)+'/isLocked').once('value', l => {
            el.innerText = `${getName(id)}: [${(t.val()||'NONE').toUpperCase()} - ${l.val()?'B·∫¢O TR√å':'ONLINE'}]`;
        });
    });
}

/**
 * L·∫ÆNG NGHE TR·∫†NG TH√ÅI SERVER T·ªîNG QU√ÅT
 */
db.ref('server').on('value', s => {
    const data = s.val() || { isLocked: false, notice: "Welcome!" };
    isServerLocked = data.isLocked;
    document.getElementById("lockBanner").style.display = isServerLocked ? "block" : "none";
    document.getElementById("marqueeText").innerText = data.notice;
    const label = document.getElementById("srvStatusDisp");
    if(label) {
        label.innerText = isServerLocked ? "TR·∫†NG TH√ÅI: ƒêANG KH√ìA" : "TR·∫†NG TH√ÅI: ƒêANG M·ªû";
        label.style.color = isServerLocked ? "#ff0000" : "#00ff00"; // ƒê·ªè khi kh√≥a, Xanh khi m·ªü
    }
    refreshUI();
});

/**
 * H√ÄM ƒêƒÇNG K√ù: PHONG C√ÅCH HO√ÄNG GIA, CH·∫∂N 5-15, KH√îNG ALERT
 */
function register() {
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value.trim();
    const stBox = document.getElementById("logStatusText");
    if (u.length < 5 || u.length > 15) { stBox.innerText = "DANH T√ÅNH PH·∫¢I T·ª™ 5 ƒê·∫æN 15 K√ù T·ª∞!"; return; }
    if (p.length < 6) { stBox.innerText = "M·∫¨T CH·ªà PH·∫¢I C√ì √çT NH·∫§T 6 K√ù T·ª∞!"; return; }
    stBox.innerText = "KHAI M·ªû DANH T√ÅNH TR√äN TI√äN B·∫¢NG...";
    auth.createUserWithEmailAndPassword(u + "@casino.com", p)
    .then(r => {
        stBox.innerText = "DANH T√ÅNH ƒê√É ƒê∆Ø·ª¢C KH·∫ÆC GHI - TH√ÄNH C√îNG!";
        return db.ref('users/' + r.user.uid).set({ username: u, money: 1000000, isAdmin: false, isSuperAdmin: false });
    })
    .catch(e => { stBox.innerText = e.code === 'auth/email-already-in-use' ? "DANH T√ÅNH N√ÄY ƒê√É ƒê∆Ø·ª¢C CH·ª¶ NH√ÇN KH√ÅC CHI·∫æM H·ªÆU!" : "THI√äN ƒê·∫†O TR·ª§C TR·∫∂C - L·ªñI KH·ªûI T·∫†O!"; });
}

/**
 * H√ÄM ƒêƒÇNG NH·∫¨P: PHONG C√ÅCH HO√ÄNG GIA, KH√îNG ALERT
 */
function login() { 
    const u = document.getElementById("username").value.trim().toLowerCase(), p = document.getElementById("password").value.trim();
    const stBox = document.getElementById("logStatusText");
    stBox.innerText = "TRUY QU√âT TH·∫¶N TH·ª®C - ƒêANG X√ÅC TH·ª∞C...";
    auth.signInWithEmailAndPassword(u + "@casino.com", p).catch(() => { stBox.innerText = "M·∫¨T CH·ªà SAI L·ªÜCH - TRUY C·∫¨P B·ªä T·ª™ CH·ªêI!"; });
}

/**
 * THEO D√ïI TR·∫†NG TH√ÅI ƒêƒÇNG NH·∫¨P (AUTH STATE)
 */
auth.onAuthStateChanged(user => {
    const stBox = document.getElementById("logStatusText");
    const aForm = document.getElementById("authForm");
    if (user) {
        startListeners();
        db.ref('users/' + user.uid).on('value', s => {
            userData = s.val(); if(!userData) return;
            userData.uid = user.uid;
            document.getElementById("loginPanel").style.display = "none";
            document.getElementById("lobbyPanel").style.display = "block";
            document.getElementById("lobbyName").innerText = userData.username.toUpperCase();
            document.getElementById("lobbyMoney").innerText = "S·ªë d∆∞: " + formatMoney(userData.money);
            const rDisp = document.getElementById("myRankDisplay");
            if(userData.isSuperAdmin) { rDisp.innerText = "üëëADMIN T·ªêI CAOüëë"; rDisp.className = "role-badge role-sad"; document.getElementById("sadDashboard").style.display = "block"; }
            else if(userData.isAdmin) { rDisp.innerText = "AD"; rDisp.className = "role-badge role-ad"; }
            else { rDisp.innerText = "MEM"; rDisp.className = "role-badge role-mem"; }
        });
        db.ref('users').on('value', snap => {
            const data = snap.val(); if(!data) return;
            const arr = Object.keys(data).map(id => ({id, ...data[id]})).sort((a,b) => b.money - a.money);
            let h10 = ""; arr.slice(0, 10).forEach((u, i) => {
                let m = u.money, title = "Ph√†m Nh√¢n", color = "#aaa", cls = "";
                if (m >= 1000000000000000) { title = "Ti√™n T√¥n"; color = "#fff"; cls = "rank-vocuc-item"; }
                else if (m >= 1000000000000) { title = "ƒê·∫°i ƒê·ªô Ki·∫øp"; color = "#ff3d00"; cls = "rank-do-kiep"; }
                else if (m >= 500000000000) { title = "H·ª£p Th·ªÉ"; color = "#d500f9"; cls = "rank-hop-the"; }
                else if (m >= 10000000000) { title = "Luy·ªán H∆∞"; color = "#ffea00"; cls = "rank-luyen-hu"; }
                else if (m >= 1000000000) { title = "H√≥a Th·∫ßn"; color = "#00e676"; cls = "rank-hoa-than"; }
                else if (m >= 500000000) { title = "Nguy√™n Anh"; color = "#00e5ff"; cls = "rank-nguyen-anh"; }
                else if (m >= 10000000) { title = "K·∫øt ƒêan"; color = "#2979ff"; }
                else if (m >= 1000000) { title = "Tr√∫c C∆°"; color = "#d500f9"; }
                else { title = "Ph√†m Nh√¢n"; color = "#999"; }
                h10 += `<div class="user-item-card ${cls}" style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #222;">
                    <span><b style="color:#ffd700; margin-right:10px;">#${i+1}</b><b>${u.username.toUpperCase()}</b><br><span class="tu-vi-tag" style="background:${color}; color:#000;">${title}</span></span>
                    <b style="color:#4caf50; font-size:16px;">${formatMoney(u.money)}</b>
                </div>`;
            });
            document.getElementById("top10List").innerHTML = h10;
            if(userData && userData.isSuperAdmin) {
                let hSad = ""; arr.forEach(u => {
                    const cVal = inputCache[u.id] || "";
                    hSad += `<div class="user-item-card"><div style="display:flex; justify-content:space-between;"><b style="font-size:13px; color:#ffd700;">${u.username.toUpperCase()}</b><span style="color:#4caf50;">${formatMoney(u.money)}</span></div>
                        <div class="control-grid">
                            <input type="number" id="amt_${u.id}" class="sad-input" style="padding:5px; margin:0; font-size:12px; height:38px;" placeholder="$$" value="${cVal}" oninput="inputCache['${u.id}']=this.value">
                            <button onclick="editM('${u.id}',1)" class="btn-mini" style="background:green;">+</button>
                            <button onclick="editM('${u.id}',-1)" class="btn-mini" style="background:red;">-</button>
                            <button onclick="toggleAD('${u.id}',${u.isAdmin})" class="btn-mini" style="background:${u.isAdmin?'#ffd700':'#444'};color:${u.isAdmin?'#000':'#fff'}">AD</button>
                            <button onclick="delN('${u.id}')" class="btn-mini" style="background:#333; ${u.isSuperAdmin?'display:none;':''}">X</button>
                        </div></div>`;
                });
                document.getElementById("masterUserList").innerHTML = hSad;
            }
        });
    } else {
        // HI·ªÜU ·ª®NG K·∫æT N·ªêI KHI KH√îNG C√ì PHI√äN L√ÄM VI·ªÜC C≈® (S·∫¢NH 1 STYLE)
        stBox.innerText = "ƒêANG KH·ªûI T·∫†O LI√äN K·∫æT ƒê·∫æ CH·∫æ...";
        setTimeout(() => { 
            stBox.innerText = "LINH KH√ç QUY T·ª§ - K·∫æT N·ªêI TH√ÄNH C√îNG!"; 
            aForm.style.display = "block"; 
        }, 1500);
    }
});

/**
 * H√ÄM ƒêƒÇNG XU·∫§T (LOGOUT)
 */
function logout() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
